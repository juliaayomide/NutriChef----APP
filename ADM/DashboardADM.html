<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NutriChef - Dashboard</title>
  <link rel="stylesheet" href="./css/dashboard.css">
  <link rel="stylesheet" href="./css/dashUsuario.css">
  <link rel="stylesheet" href="./css/dashReceitas.css">
  <link rel="stylesheet" href="./css/dashAvaliacoes.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
<div class="app">
  <aside class="sidebar card">
    
    <nav>
      <a class="nav-item active" href="#" data-screen="dashboard">Dashboard</a>
      <a class="nav-item" href="#" data-screen="receitas">Receitas</a>
      <!-- <a class="nav-item" href="#" data-screen="denuncias">Avaliações</a> -->
      <a class="nav-item" href="#"data-screen="graficos">Gráficos</a>
    </nav>
  
  </aside>

  <main class="main">
    <div id="admin-fixed-name">
      <div id="admin-info" style="color:var(--muted);font-size:13px"></div>
      <!-- <div class="avatar"></div> -->
    </div>

    <div class="card topbar">
      <div class="top-left">
        <div class="title" id="page-title">Visão Geral</div>
        <div class="logo"><img src="logo.png" alt="logo"></div>
        <div class="search" style="display: none;">
          <input placeholder="Pesquisar..." id="global-search">
        </div>
      </div>
    </div>

    <div class="screens">
      <!-- DASHBOARD -->
      <section class="card" id="screen-dashboard">
        <div class="grid">
          <div>
          
            <div style="height:18px"></div>
              <button id="btn-rpa" class="btn btn-rpa" style="
                margin-bottom:15px;
                padding:10px 16px;
                background:#ff7f00;
                border:none;
                border-radius:8px;
                color:white;
                font-weight:600;
                cursor:pointer;
              ">
                Adicionar receitas (RPA)
              </button>
            <div class="stats">
              <div class="stat">
                <div class="label">Receitas postadas</div>
                <div class="num" id="total-receitas">0</div>
              </div>
              <div class="stat">
                <div class="label">Comentários</div>
                <br>
                <div class="num" id="total-comentarios">0</div>
              </div>
              <div class="stat">
                <div class="label">Usuários cadastrados</div>
                <div class="num" id="total-usuarios">0</div>
              </div>
            </div>
          </div>
      <aside>
       
            <h4>Usuários cadastrados por mês</h4>
            <div class="card" style="padding:15px">
              <canvas id="graficoUsuarios" width="300" height="200"></canvas>
            </div>

          </aside>

          
            <!-- Card de Usuários -->
            <div class="card users-card">
              <div class="users-card-header">
                <h4>Usuários</h4>
                <div class="meta-muted" id="users-count-inline">0</div>
              </div>

              <input id="user-search" class="user-search" style="border: solid 1px #000;" placeholder="Pesquisar usuários por nome..." />

              <div id="users-container">
                <div id="users-list" class="users-list"></div>
                <div id="no-users-msg" class="no-users" style="display:none">Nenhum usuário cadastrado no momento.</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- RECEITAS -->
      <section class="card" id="screen-receitas" style="display:none">
        <h3>Receitas Cadastradas</h3>

        <div class="receitas-top">
          <input type="text" id="search-receita" style="border: solid 3px #000;" placeholder="Pesquisar receita..." />
        </div>

        <ul id="receitas-lista" class="receitas-lista"></ul>
      </section>

      <!-- Modal de confirmação -->
      <div id="delete-modal" class="modal" style="display:none;">
        <div class="modal-content">
          <h3>Excluir Receita</h3>
          <p>Tem certeza que deseja excluir esta receita?</p>
          <div class="modal-buttons">
            <button id="confirm-delete">Sim, excluir</button>
            <button id="cancel-delete">Cancelar</button>
          </div>
        </div>
      </div>


      <!-- AVALIAÇÕES -->
      <section class="card" id="screen-denuncias" style="display:none">
        <h3>Avaliações</h3>

        <div class="denuncias-top">
          <input type="text" id="search-denuncia" style="border: solid 1px #000; width: 350px; height: 35px; border-radius: 7px;" placeholder="Pesquisar avaliações..." />
        </div>

        <div id="denuncias-container" class="denuncias-container"></div>
      </section>

      <!-- Gráficos  -->
      <section class="card" id="screen-graficos" style="display:none">

        <h3>Gráficos Gerais</h3>

        <div class="card" style="padding:20px; margin-bottom:20px;">
            <h4>Ingredientes mais usados (%)</h4>
            <canvas id="graficoIngredientes" width="400" height="250"></canvas>
        </div>

        <div id="lista-legenda-ingredientes" class="legenda-lista"></div>

    </section>

      <!-- Modal de Receitas -->
      <div id="modal-receita" class="modal" style="display:none;">
        <div class="modal-content"> 
          <div id="conteudo-receita"></div>
        </div>
      </div>

      <!-- Modal de Usuário -->
      <div id="modal-usuario" class="modal-usuario hidden">
        <div class="modal-content">
          
          <button class="close-btn" id="fechar-modal-usuario">×</button>

          <h2>Informações do Usuário</h2>

          <div class="modal-info-item"><strong>Nome:</strong> <span id="modal-nome"></span></div>
          <div class="modal-info-item"><strong>Email:</strong> <span id="modal-email"></span></div>
          <div class="modal-info-item"><strong>ID:</strong> <span id="modal-id"></span></div>
          <div class="modal-info-item"><strong>Cadastrado em:</strong> <span id="modal-data"></span></div>
          
          <div class="modal-actions">
            <button id="btn-suspender" class="btn suspender">Suspender Usuário</button>
            <button id="btn-ativar" class="btn ativar">Ativar Usuário</button>
          </div>
        </div>
      </div>

      <div id="modal-motivo" class="modal-usuario hidden">
        <div class="modal-content">
          <button class="close-btn" id="fechar-modal-motivo">×</button>

          <h2>Motivo</h2>

          <textarea id="motivo-texto"
            placeholder="Descreva o motivo..."
            style="width: 100%; height: 120px; padding: 10px; resize: none; font-size: 16px;">
          </textarea>

          <button id="confirmar-motivo" class="btn ativar" style="margin-top: 20px;">Confirmar</button>
        </div>
      </div>

      <div id="modal-rpa" class="modal-usuario hidden">
        <div class="modal-content">
          <button class="close-btn" id="fechar-modal-rpa">×</button>

          <h2>Adicionar receitas</h2>

          <p>Informe o termo para buscar receitas automaticamente na RPA:</p>

          <input id="rpa-termo"
                placeholder="Ex: frango, bolo de chocolate, salada…"
                style="width:100%; padding:10px; font-size:16px; margin-top:10px; border-radius:6px; border:1px solid #ccc;" />

          <button id="btn-executar-rpa"
                  style="margin-top:20px; width:100%; padding:12px; background:#ff7f00; color:white; border:none; border-radius:6px; font-size:16px; font-weight:bold; cursor:pointer;">
            Executar coleta
          </button>

          <!-- LOADER DE PORCENTAGEM -->
          <div id="loader-progress" class="loader-progress-container" style="display:none;">
            <div class="progress-circle">
              <div id="progress-number">0%</div>
            </div>
            <span id="progress-text">Coletando receitas...</span>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

function atualizarProgresso(valor) {
  const circle = document.querySelector(".progress-circle");
  const number = document.getElementById("progress-number");

  circle.style.background = `conic-gradient(#ff7f00 ${valor}%, #ddd ${valor}%)`;
  number.textContent = `${valor}%`;
}



const modalRpa = document.getElementById("modal-rpa");
const btnRpa = document.getElementById("btn-rpa");
const fecharRpa = document.getElementById("fechar-modal-rpa");
const btnExecutarRpa = document.getElementById("btn-executar-rpa");
const inputTermo = document.getElementById("rpa-termo");

// abrir modal
btnRpa.addEventListener("click", () => {
  modalRpa.classList.remove("hidden");
});

// fechar modal
fecharRpa.addEventListener("click", () => {
  modalRpa.classList.add("hidden");
});

// enviar termo para backend que chama o script Python
btnExecutarRpa.addEventListener("click", async () => {
  const termo = inputTermo.value.trim();

  if (!termo) {
    alert("Digite um termo!");
    return;
  }

  // esconder formulário e mostrar loader
  btnExecutarRpa.style.display = "none";
  inputTermo.style.display = "none";
  const loader = document.getElementById("loader-progress");
  loader.style.display = "flex";

  const fases = [
    { pct: 5,   msg: "Enviando termo para a RPA..." },
    { pct: 25,  msg: "Abrindo navegador virtual..." },
    { pct: 45,  msg: `Buscando receitas para '${termo}'...` },
    { pct: 65,  msg: "Processando dados coletados..." },
    { pct: 85,  msg: "Validando receitas..." },
  ];

  let idx = 0;

  function avancarFase() {
    if (idx < fases.length) {
      atualizarProgresso(fases[idx].pct);
      document.getElementById("progress-text").innerText = fases[idx].msg;
      idx++;
    }
  }

  // executa fases em intervalos automáticos
  const faseInterval = setInterval(avancarFase, 900);

  try {
    const response = await fetch("http://localhost:3000/api/rpa", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ termo })
    });

    const data = await response.json();

    clearInterval(faseInterval);

    // Mostrar fase final (100%)
    atualizarProgresso(100);
    document.getElementById("progress-text").innerText = "Salvando no banco de dados...";

    setTimeout(() => {
      loader.style.display = "none";
      btnExecutarRpa.style.display = "block";
      inputTermo.style.display = "block";
      modalRpa.classList.add("hidden");

      btnExecutarRpa.innerText = "Executar coleta";
      btnExecutarRpa.disabled = false;

      if (data.success) {
        alert("Coleta concluída! Receitas adicionadas.");
      } else {
        alert("Erro: " + (data.error || "Falha ao executar RPA"));
      }
    }, 800);

  } catch (err) {
    clearInterval(faseInterval);

    alert("Erro ao conectar com o servidor.");

    loader.style.display = "none";
    btnExecutarRpa.style.display = "block";
    inputTermo.style.display = "block";
  }
});


btnExecutarRpa.addEventListener("click", async () => {
  const termo = inputTermo.value.trim();

  if (!termo) {
    alert("Digite um termo!");
    return;
  }

  // esconder formulário e mostrar loader
  btnExecutarRpa.style.display = "none";
  inputTermo.style.display = "none";
  document.getElementById("loader-progress").style.display = "flex";

  let progresso = 0;
  const interval = setInterval(() => {
    progresso = Math.min(progresso + 5, 95);
    atualizarProgresso(progresso);
  }, 300);

  try {
    const response = await fetch("http://localhost:3000/api/rpa", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ termo })
    });

    clearInterval(interval);
    atualizarProgresso(100);

    const data = await response.json();

    setTimeout(() => {
      document.getElementById("loader-progress").style.display = "none";
      btnExecutarRpa.style.display = "block";
      inputTermo.style.display = "block";
      modalRpa.classList.add("hidden");

      btnExecutarRpa.innerText = "Executar coleta";
      btnExecutarRpa.disabled = false;

      if (data.success) {
        alert("Coleta concluída! Receitas adicionadas.");
      } else {
        alert("Erro: " + (data.error || "Falha ao executar RPA"));
      }
    }, 500);

  } catch (err) {
    clearInterval(interval);

    alert("Erro ao conectar com o servidor.");

    document.getElementById("loader-progress").style.display = "none";
    btnExecutarRpa.style.display = "block";
    inputTermo.style.display = "block";
  }
});



async function carregarUsuarios() {
  try {
    const res = await fetch("http://localhost:3000/api/usuariosPorMes");
    const dados = await res.json();

    const labels = dados.map(x => x.mes);
    const valores = dados.map(x => x.total);

    const ctx = document.getElementById("graficoUsuarios").getContext("2d");

    // Gradiente suave azul
    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, "rgba(0, 122, 255, 0.35)");
    gradient.addColorStop(1, "rgba(0, 122, 255, 0)");

    new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "Usuários cadastrados",
          data: valores,
          borderColor: "rgb(255, 119, 0)",
          backgroundColor: gradient,
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointRadius: 4,
          pointBackgroundColor: "rgb(250, 137, 50)",
          pointBorderWidth: 2,
          pointHoverRadius: 7,
          pointHoverBackgroundColor: "white",
          pointHoverBorderColor: "rgb(250, 137, 50)",
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            labels: {
              font: { size: 13, weight: "600" },
              color: "#444"
            }
          },
          tooltip: {
            backgroundColor: "rgba(30, 30, 30, 0.85)",
            padding: 10,
            titleFont: { size: 14, weight: "bold" },
            bodyFont: { size: 13 },
            cornerRadius: 8
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              font: { size: 12 },
              color: "#666"
            },
            grid: {
              color: "rgba(0,0,0,0.08)"
            }
          },
          x: {
            ticks: {
              font: { size: 12 },
              color: "#666"
            },
            grid: { display: false }
          }
        }
      }
    });

  } catch (err) {
    console.error("Erro ao carregar gráfico:", err);
  }
}

carregarUsuarios();
</script>



  <script src="./js/dashUsuario.js"></script>
  <script src="./js/dashReceitas.js"></script>
</body>
</html>
